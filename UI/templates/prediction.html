<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>University Predictor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
    .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 20px; color: #333; text-align: center; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
    select, input { margin: 5px 0; padding: 8px; width: 250px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    select:focus, input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.3); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #f8f9fa; font-weight: bold; color: #495057; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #6c757d; cursor: not-allowed; }
    .hidden { display: none; }
    .loading { opacity: 0.6; pointer-events: none; }
    .error { color: #dc3545; margin: 10px 0; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; }
    .success { color: #155724; margin: 10px 0; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; }
    .info { color: #0c5460; margin: 10px 0; padding: 10px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; }
    .recommendation { font-weight: bold; }
    .highly-recommended { color: #28a745; }
    .recommended { color: #ffc107; }
    .not-recommended { color: #dc3545; }
    .confidence-high { background-color: #d4edda; }
    .confidence-medium { background-color: #fff3cd; }
    .confidence-low { background-color: #f8d7da; }
    .form-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .form-col { flex: 1; min-width: 250px; }
    .controls { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 15px 0; }
    .stats { display: flex; gap: 20px; margin: 15px 0; flex-wrap: wrap; }
    .stat-item { background: #e9ecef; padding: 10px; border-radius: 4px; text-align: center; flex: 1; min-width: 150px; }
    .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
    .stat-label { font-size: 12px; color: #6c757d; text-transform: uppercase; }
  </style>
</head>
<body>
<div class="container">
  <h2>üéì University Admission Predictor</h2>

  <!-- User Input Form -->
  <div id="input-form">
    <div class="form-row">
      <div class="form-col">
        <div class="form-group">
          <label>Year:</label>
          <input type="number" id="year" value="2024" min="2000" max="2030">
        </div>
        
        <div class="form-group">
          <label>Z-Score:</label>
          <input type="number" id="z_score" step="0.001" min="0" max="3" placeholder="Enter your Z-Score (0.000 - 3.000)">
        </div>
      </div>
      
      <div class="form-col">
        <div class="form-group">
          <label>Stream:</label>
          <select id="stream">
            <option value="">Select Stream</option>
            <option value="Physical Science">Physical Science</option>
            <option value="Biological Science">Biological Science</option>
            <option value="Commerce">Commerce</option>
            <option value="Arts">Arts</option>
            <option value="Engineering Technology">Engineering Technology</option>
            <option value="Biosystems Technology">Biosystems Technology</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>District:</label>
          <select id="district">
            <option value="">Select District</option>
            <option value="COLOMBO">COLOMBO</option>
            <option value="GAMPAHA">GAMPAHA</option>
            <option value="KALUTARA">KALUTARA</option>
            <option value="KANDY">KANDY</option>
            <option value="MATALE">MATALE</option>
            <option value="NUWARA ELIYA">NUWARA ELIYA</option>
            <option value="GALLE">GALLE</option>
            <option value="MATARA">MATARA</option>
            <option value="HAMBANTOTA">HAMBANTOTA</option>
            <option value="JAFFNA">JAFFNA</option>
            <option value="KILINOCHCHI">KILINOCHCHI</option>
            <option value="MANNAR">MANNAR</option>
            <option value="VAVUNIYA">VAVUNIYA</option>
            <option value="MULLAITIVU">MULLAITIVU</option>
            <option value="BATTICALOA">BATTICALOA</option>
            <option value="AMPARA">AMPARA</option>
            <option value="TRINCOMALEE">TRINCOMALEE</option>
            <option value="KURUNEGALA">KURUNEGALA</option>
            <option value="PUTTALAM">PUTTALAM</option>
            <option value="ANURADHAPURA">ANURADHAPURA</option>
            <option value="POLONNARUWA">POLONNARWA</option>
            <option value="BADULLA">BADULLA</option>
            <option value="MONERAGALA">MONERAGALA</option>
            <option value="RATNAPURA">RATNAPURA</option>
            <option value="KEGALLE">KEGALLE</option>
          </select>
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin: 20px 0;">
      <button id="predict-btn">üöÄ Generate Predictions</button>
    </div>
    
    <div id="loading-message" class="hidden info">‚è≥ Generating predictions, please wait...</div>
    <div id="error-message" class="error hidden"></div>
    <div id="success-message" class="success hidden"></div>
  </div>

  <!-- Predictions Table -->
  <div id="predictions-section" class="hidden">
    <div id="prediction-info">
      <h3>üìä Predicted Courses</h3>
      <div id="session-info" class="info"></div>
      
      <!-- Statistics -->
      <div class="stats" id="prediction-stats">
        <div class="stat-item">
          <div class="stat-value" id="total-predictions">0</div>
          <div class="stat-label">Total Predictions</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="highly-recommended-count">0</div>
          <div class="stat-label">Highly Recommended</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="recommended-count">0</div>
          <div class="stat-label">Recommended</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="avg-probability">0%</div>
          <div class="stat-label">Avg Probability</div>
        </div>
      </div>
    </div>
    
    <div class="controls">
      <div style="margin-bottom: 10px;">
        <button id="view-courses-btn">üìö View by Courses</button>
        <button id="view-universities-btn">üè´ View by Universities</button>
      </div>
      <div style="margin-bottom: 10px;">
        <button id="select-all-btn">‚úÖ Select All</button>
        <button id="select-none-btn">‚ùå Select None</button>
        <button id="select-recommended-btn">‚≠ê Select Highly Recommended</button>
      </div>
      <div>
        <input type="text" id="search-filter" placeholder="üîç Search courses or universities..." style="width: 300px; padding: 8px;">
      </div>
    </div>

    <table id="predictions-table">
      <thead>
        <tr>
          <th>Select</th>
          <th>University</th>
          <th>Course</th>
          <th>Predicted Cutoff</th>
          <th>Your Probability</th>
          <th>Recommendation</th>
          <th>Confidence</th>
          <th>Aptitude Test</th>
          <th>All-Island Merit</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    
    <div id="save-controls" style="margin-top: 15px; text-align: center;">
      <button id="save-selected-btn">üíæ Save Selected Predictions</button>
      <span id="selection-count" class="info" style="margin-left: 15px;">0 predictions selected</span>
    </div>
  </div>

  <!-- History Section -->
  <div id="history-section" style="margin-top: 30px;">
    <h3>üìú Previous Predictions</h3>
    <button id="view-history-btn">üìã View History</button>
    <div id="history-content" class="hidden">
      <div id="history-list"></div>
    </div>
  </div>
</div>

<script>
  // Global variables
  let currentSessionId = null;
  let currentView = 'courses'; // 'courses' | 'universities'
  let coursePredictions = [];
  let universityPredictions = [];
  let allPredictions = [];
  let filteredPredictions = [];
  
  // Get JWT token from localStorage
  function getToken() {
    return localStorage.getItem('access_token');
  }

  // Show/hide loading state
  function setLoading(isLoading) {
    const form = document.getElementById('input-form');
    const loadingMsg = document.getElementById('loading-message');
    const predictBtn = document.getElementById('predict-btn');
    
    if (isLoading) {
      form.classList.add('loading');
      loadingMsg.classList.remove('hidden');
      predictBtn.disabled = true;
      predictBtn.textContent = '‚è≥ Processing...';
    } else {
      form.classList.remove('loading');
      loadingMsg.classList.add('hidden');
      predictBtn.disabled = false;
      predictBtn.textContent = 'üöÄ Generate Predictions';
    }
  }

  // Show error message
  function showError(message) {
    const errorDiv = document.getElementById('error-message');
    const successDiv = document.getElementById('success-message');
    
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    successDiv.classList.add('hidden');
    
    setTimeout(() => errorDiv.classList.add('hidden'), 10000);
  }

  // Show success message
  function showSuccess(message) {
    const successDiv = document.getElementById('success-message');
    const errorDiv = document.getElementById('error-message');
    
    successDiv.textContent = message;
    successDiv.classList.remove('hidden');
    errorDiv.classList.add('hidden');
    
    setTimeout(() => successDiv.classList.add('hidden'), 5000);
  }

  
  // Validate form inputs
  function validateInputs() {
    const year = document.getElementById('year').value;
    const z_score = document.getElementById('z_score').value;
    const stream = document.getElementById('stream').value;
    const district = document.getElementById('district').value;

    if (!year || !z_score || !stream || !district) {
      showError("Please fill in all fields.");
      return false;
    }

    const yearNum = parseInt(year);
    const zScoreNum = parseFloat(z_score);

    if (yearNum < 2000 || yearNum > 2030) {
      showError("Year must be between 2000 and 2030.");
      return false;
    }

    if (zScoreNum < 0 || zScoreNum > 3) {
      showError("Z-Score must be between 0.000 and 3.000.");
      return false;
    }

    return { year: yearNum, z_score: zScoreNum, stream: stream, district: district };
  }

  // Handle API errors
  function handleApiError(response, data) {
    let errorMessage = "An unexpected error occurred.";
    
    if (data && data.error) {
      errorMessage = data.error;
    } else if (response.status === 401) {
      errorMessage = "Your session has expired. Please login again.";
      // Redirect to login after a delay
      setTimeout(() => {
        window.location.href = "/login/";
      }, 2000);
    } else if (response.status === 403) {
      errorMessage = "You don't have permission to access this feature.";
    } else if (response.status === 429) {
      errorMessage = "Too many requests. Please try again later.";
    } else if (response.status === 503) {
      errorMessage = "Prediction service is currently unavailable. Please try again later.";
    }
    
    return errorMessage;
  }

  // Calculate confidence score based on probability and other factors
  function calculateConfidenceScore(prediction) {
    let confidence = 0.5; // Base confidence
    
    // Adjust based on probability
    if (prediction.predicted_probability >= 0.8) confidence += 0.3;
    else if (prediction.predicted_probability >= 0.6) confidence += 0.2;
    else if (prediction.predicted_probability >= 0.4) confidence += 0.1;
    
    // Adjust based on recommendation
    if (prediction.recommendation === 'Highly Recommended') confidence += 0.2;
    else if (prediction.recommendation === 'Recommended') confidence += 0.1;
    
    return Math.min(confidence, 1.0);
  }

  // Generate predictions
  async function generatePredictions() {
    const token = getToken();
    if (!token) {
      showError("Please login first to access predictions.");
      setTimeout(() => {
        window.location.href = "/login/";
      }, 2000);
      return;
    }

    const inputs = validateInputs();
    if (!inputs) return;
    
    // Request top-N from backend (default 100)
    inputs.top_n = 100;

    setLoading(true);
    
    try {
      const response = await fetch('/api/predictions/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(inputs)
      });

      const data = await response.json();
      
      if (response.ok) {
        if ((data.predictions && data.predictions.length > 0) || (data.unique_courses && data.unique_courses.length > 0)) {
          displayPredictions(data);
          showSuccess(`Successfully generated ${data.total_predictions} predictions!`);
        } else {
          showError(`No predictions found. This might be due to no matching courses for your stream or missing model data.`);
          console.log('Empty predictions received:', data);
        }
      } else {
        const errorMessage = handleApiError(response, data);
        showError(errorMessage);
        console.error('API Error:', data);
      }
    } catch (error) {
      showError("Network error. Please check your connection and try again.");
      console.error('Network error:', error);
    } finally {
      setLoading(false);
    }
  }

  // Display predictions in table
  function displayPredictions(data) {
    currentSessionId = data.session_id;
    
    // Update session info
    const sessionInfo = document.getElementById('session-info');
    sessionInfo.innerHTML = `
      <strong>Session ID:</strong> ${data.session_id} | 
      <strong>Total Predictions:</strong> ${data.total_predictions} | 
      <strong>Confidence Level:</strong> ${data.confidence_level || 'High'} | 
      <strong>Generated:</strong> ${data.generated_at ? new Date(data.generated_at).toLocaleString() : 'Now'}
    `;

    // Prefer explicit unique lists from API; fallback to 'predictions'
    coursePredictions = (data.unique_courses && data.unique_courses.length) ? data.unique_courses : (data.predictions || []);
    universityPredictions = data.unique_universities || [];

    // Add confidence scores to predictions
    coursePredictions.forEach(pred => {
      pred.confidence_score = calculateConfidenceScore(pred);
    });
    
    if (universityPredictions.length > 0) {
      universityPredictions.forEach(pred => {
        pred.confidence_score = calculateConfidenceScore(pred);
      });
    }

    // Build working lists based on current view
    allPredictions = (currentView === 'universities') ? universityPredictions : coursePredictions;
    filteredPredictions = [...allPredictions];

    renderPredictionsTable();
    updateSelectionCount();
    updatePredictionStats();
    document.getElementById('predictions-section').classList.remove('hidden');
  }

  // Update prediction statistics
  function updatePredictionStats() {
    const total = allPredictions.length;
    const highlyRecommended = allPredictions.filter(p => p.recommendation === 'Highly Recommended').length;
    const recommended = allPredictions.filter(p => p.recommendation === 'Recommended').length;
    const avgProbability = allPredictions.length > 0 ? 
      (allPredictions.reduce((sum, p) => sum + p.predicted_probability, 0) / allPredictions.length) : 0;

    document.getElementById('total-predictions').textContent = total;
    document.getElementById('highly-recommended-count').textContent = highlyRecommended;
    document.getElementById('recommended-count').textContent = recommended;
    document.getElementById('avg-probability').textContent = (avgProbability * 100).toFixed(1) + '%';
  }

  // Render predictions table
  function renderPredictionsTable() {
    const tbody = document.querySelector('#predictions-table tbody');
    tbody.innerHTML = '';

    filteredPredictions.forEach((pred, index) => {
      const tr = document.createElement('tr');
      
      // Apply confidence-based styling
      const confidenceClass = getConfidenceClass(pred.confidence_score);
      tr.className = confidenceClass;
      
      const recommendationClass = getRecommendationClass(pred.recommendation);
      
      tr.innerHTML = `
        <td><input type="checkbox" class="select-prediction" data-index="${index}" 
                   data-university="${escapeHtml(pred.university_name)}" 
                   data-course="${escapeHtml(pred.course_name)}" 
                   data-cutoff="${pred.predicted_cutoff}" 
                   data-probability="${pred.predicted_probability}" 
                   data-aptitude="${pred.aptitude_test_required}" 
                   data-merit="${pred.all_island_merit}"
                   data-recommendation="${escapeHtml(pred.recommendation)}"
                   data-confidence="${pred.confidence_score || 0.5}"></td>
        <td title="${escapeHtml(pred.university_name)}">${truncateText(pred.university_name, 30)}</td>
        <td title="${escapeHtml(pred.course_name)}">${truncateText(pred.course_name, 40)}</td>
        <td>${pred.predicted_cutoff}</td>
        <td>${(pred.predicted_probability * 100).toFixed(1)}%</td>
        <td class="recommendation ${recommendationClass}">${pred.recommendation}</td>
        <td>${pred.confidence_score ? (pred.confidence_score * 100).toFixed(0) + '%' : 'N/A'}</td>
        <td>${pred.aptitude_test_required ? 'Yes' : 'No'}</td>
        <td>${pred.all_island_merit ? 'Yes' : 'No'}</td>
      `;
      tbody.appendChild(tr);
    });

    // Add event listeners for checkboxes
    document.querySelectorAll('.select-prediction').forEach(checkbox => {
      checkbox.addEventListener('change', updateSelectionCount);
    });
  }

  // Helper functions
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function truncateText(text, maxLength) {
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
  }

  function getConfidenceClass(confidence) {
    if (!confidence) return '';
    if (confidence >= 0.7) return 'confidence-high';
    if (confidence >= 0.5) return 'confidence-medium';
    return 'confidence-low';
  }

  function getRecommendationClass(recommendation) {
    switch (recommendation) {
      case 'Highly Recommended': return 'highly-recommended';
      case 'Recommended': return 'recommended';
      case 'Not Recommended': return 'not-recommended';
      default: return '';
    }
  }

  // Update selection count
  function updateSelectionCount() {
    const selectedCount = document.querySelectorAll('.select-prediction:checked').length;
    document.getElementById('selection-count').textContent = `${selectedCount} predictions selected`;
  }

  // Selection controls
  function selectAll() {
    document.querySelectorAll('.select-prediction').forEach(cb => {
      cb.checked = true;
    });
    updateSelectionCount();
  }

  function selectNone() {
    document.querySelectorAll('.select-prediction').forEach(cb => {
      cb.checked = false;
    });
    updateSelectionCount();
  }

  function selectRecommended() {
    document.querySelectorAll('.select-prediction').forEach(cb => {
      const recommendation = cb.dataset.recommendation;
      cb.checked = recommendation === 'Highly Recommended';
    });
    updateSelectionCount();
  }

  // Filter predictions
  function filterPredictions() {
    const searchTerm = document.getElementById('search-filter').value.toLowerCase();
    
    if (!searchTerm) {
      filteredPredictions = [...allPredictions];
    } else {
      filteredPredictions = allPredictions.filter(pred => 
        pred.university_name.toLowerCase().includes(searchTerm) ||
        pred.course_name.toLowerCase().includes(searchTerm) ||
        pred.recommendation.toLowerCase().includes(searchTerm)
      );
    }
    
    renderPredictionsTable();
    updateSelectionCount();
  }

  // Save selected predictions
  async function saveSelectedPredictions() {
    const token = getToken();
    if (!token) {
      showError("Please login first.");
      return;
    }

    const checkboxes = document.querySelectorAll('.select-prediction:checked');
    if (!checkboxes.length) {
      showError("Please select at least one prediction to save.");
      return;
    }

    if (!currentSessionId) {
      showError("No active prediction session. Please generate predictions first.");
      return;
    }

    const selectedPredictions = Array.from(checkboxes).map(cb => ({
      university_name: cb.dataset.university,
      course_name: cb.dataset.course,
      predicted_cutoff: parseFloat(cb.dataset.cutoff),
      predicted_probability: parseFloat(cb.dataset.probability),
      aptitude_test_required: cb.dataset.aptitude === 'true',
      all_island_merit: cb.dataset.merit === 'true',
      recommendation: cb.dataset.recommendation,
      confidence_score: parseFloat(cb.dataset.confidence) || 0.5
    }));

    try {
      setLoading(true);
      
      const response = await fetch('/api/predictions/save/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          session_id: currentSessionId,
          selected_predictions: selectedPredictions
        })
      });

      const data = await response.json();
      
      if (response.ok) {
        showSuccess(`${data.total_saved} predictions saved successfully!`);
        
        // Optionally uncheck saved predictions
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectionCount();
      } else {
        const errorMessage = handleApiError(response, data);
        showError(errorMessage);
      }
    } catch (error) {
      showError("Network error. Please check your connection and try again.");
      console.error('Network error:', error);
    } finally {
      setLoading(false);
    }
  }

  // Load prediction history
  async function loadPredictionHistory() {
    const token = getToken();
    if (!token) {
      showError("Please login first.");
      return;
    }

    try {
      const response = await fetch('/api/predictions/history/', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      const data = await response.json();
      
      if (response.ok) {
        displayPredictionHistory(data.prediction_history);
      } else {
        const errorMessage = handleApiError(response, data);
        showError(errorMessage);
      }
    } catch (error) {
      showError("Failed to load prediction history.");
      console.error('History load error:', error);
    }
  }

  // Display prediction history
  function displayPredictionHistory(history) {
    const historyList = document.getElementById('history-list');
    const historyContent = document.getElementById('history-content');
    
    if (!history.length) {
      historyList.innerHTML = '<p class="info">No prediction history found.</p>';
    } else {
      const historyHTML = history.map(session => `
        <div style="border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 5px; background: #f8f9fa;">
          <strong>Session ${session.id}</strong> - ${session.stream} (${session.year})<br>
          <strong>Z-Score:</strong> ${session.z_score} | <strong>District:</strong> ${session.district}<br>
          <strong>Predictions:</strong> ${session.total_predictions_generated} generated, ${session.saved_predictions_count} saved<br>
          <strong>Confidence:</strong> ${session.confidence_level} | <strong>Date:</strong> ${new Date(session.predicted_at).toLocaleString()}<br>
        </div>
      `).join('');
      historyList.innerHTML = historyHTML;
    }
    
    historyContent.classList.remove('hidden');
  }

  // Event listeners
  document.getElementById('predict-btn').addEventListener('click', generatePredictions);
  document.getElementById('save-selected-btn').addEventListener('click', saveSelectedPredictions);
  document.getElementById('select-all-btn').addEventListener('click', selectAll);
  document.getElementById('select-none-btn').addEventListener('click', selectNone);
  document.getElementById('select-recommended-btn').addEventListener('click', selectRecommended);
  document.getElementById('search-filter').addEventListener('input', filterPredictions);
  document.getElementById('view-history-btn').addEventListener('click', loadPredictionHistory);
  document.getElementById('view-courses-btn').addEventListener('click', () => {
    currentView = 'courses';
    allPredictions = [...coursePredictions];
    filteredPredictions = [...allPredictions];
    renderPredictionsTable();
    updateSelectionCount();
    updatePredictionStats();
  });
  document.getElementById('view-universities-btn').addEventListener('click', () => {
    currentView = 'universities';
    allPredictions = [...universityPredictions];
    filteredPredictions = [...allPredictions];
    renderPredictionsTable();
    updateSelectionCount();
    updatePredictionStats();
  });

  // Initialize
  console.log('University Predictor initialized');
</script>
</body>
</html>